{% load i18n %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
<ion-footer>
{% include "sales/partials/tabbar_sales.html" with current_view='dashboard' %}
</ion-footer>
</div>
{% endif %}

<div class="p-4">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold" style="color: var(--ion-text-color);">{% trans "Ventas" %}</h1>
        <p class="text-sm mt-2" style="color: var(--ion-color-medium);">{% trans "Gestión de ventas y punto de venta" %}</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="receipt-outline" class="text-2xl text-primary"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Ventas Hoy" %}</div>
                        <div class="text-2xl font-semibold">{{ sales_count_today }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-success/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="cash-outline" class="text-2xl text-success"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Ingresos Hoy" %}</div>
                        <div class="text-2xl font-semibold">{% if HUB_CONFIG.currency == 'EUR' %}€{% elif HUB_CONFIG.currency == 'GBP' %}£{% else %}${% endif %}{{ sales_total_today|floatformat:2 }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-warning/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="calendar-outline" class="text-2xl text-warning"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Ventas Semana" %}</div>
                        <div class="text-2xl font-semibold">{{ sales_count_week }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-success/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="trending-up-outline" class="text-2xl text-success"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Ingresos Semana" %}</div>
                        <div class="text-2xl font-semibold">{% if HUB_CONFIG.currency == 'EUR' %}€{% elif HUB_CONFIG.currency == 'GBP' %}£{% else %}${% endif %}{{ sales_total_week|floatformat:2 }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Recent Sales -->
    <div class="mb-6">
        <ion-card class="m-0">
            <ion-card-header>
                <div class="flex justify-between items-center">
                    <ion-card-title>{% trans "Ventas Recientes" %}</ion-card-title>
                    <ion-button size="small" fill="clear"
                        hx-get="{% url 'sales:history' %}"
                        hx-target="#dashboard-content"
                        hx-push-url="true">
                        {% trans "Ver todas" %}
                        <ion-icon slot="end" name="arrow-forward-outline"></ion-icon>
                    </ion-button>
                </div>
            </ion-card-header>
            <ion-card-content>
                {% if recent_sales %}
                <div class="space-y-3">
                    {% for sale in recent_sales %}
                    <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--ion-color-light);">
                        <div>
                            <div class="font-medium" style="color: var(--ion-text-color);">{{ sale.sale_number }}</div>
                            <div class="text-xs" style="color: var(--ion-color-medium);">
                                {{ sale.created_at|date:"d/m/Y H:i" }}
                                {% if sale.customer_name %} - {{ sale.customer_name }}{% endif %}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold" style="color: var(--ion-color-success);">{% if HUB_CONFIG.currency == 'EUR' %}€{% elif HUB_CONFIG.currency == 'GBP' %}£{% else %}${% endif %}{{ sale.total|floatformat:2 }}</div>
                            <div class="text-xs" style="color: var(--ion-color-medium);">{{ sale.get_payment_method_display }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8" style="color: var(--ion-color-medium);">
                    <ion-icon name="receipt-outline" style="font-size: 48px;"></ion-icon>
                    <p class="mt-2">{% trans "No hay ventas recientes" %}</p>
                    <ion-button size="small" href="{% url 'sales:pos' %}" class="mt-3">
                        {% trans "Hacer primera venta" %}
                    </ion-button>
                </div>
                {% endif %}
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Payment Methods Breakdown -->
    {% if payment_methods_stats %}
    <ion-card class="m-0">
        <ion-card-header>
            <ion-card-title>{% trans "Métodos de Pago (Hoy)" %}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead style="background: var(--ion-color-step-50);">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Método" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Cantidad" %}</th>
                            <th class="px-4 py-3 text-right text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Total" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for method, stats in payment_methods_stats.items %}
                        <tr class="border-b" style="border-color: var(--ion-border-color);">
                            <td class="px-4 py-3 text-sm">
                                <div class="flex items-center gap-2">
                                    <ion-icon name="{% if method == 'cash' %}cash-outline{% elif method == 'card' %}card-outline{% elif method == 'transfer' %}swap-horizontal-outline{% else %}wallet-outline{% endif %}"></ion-icon>
                                    <span>{{ stats.label }}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-center text-sm">{{ stats.count }}</td>
                            <td class="px-4 py-3 text-right text-sm font-semibold" style="color: var(--ion-color-success);">{% if HUB_CONFIG.currency == 'EUR' %}€{% elif HUB_CONFIG.currency == 'GBP' %}£{% else %}${% endif %}{{ stats.total|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </ion-card-content>
    </ion-card>
    {% endif %}
</div>
